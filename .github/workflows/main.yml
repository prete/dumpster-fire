name: ğŸ»

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  test:  
    name: ğŸ•ğŸ•ğŸ•
    
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for s3 
        run: rclone config create s3 s3 \
          env_auth false \
          access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} \
          secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          endpoint ${{ secrets.AWS_S3_ENDPOINT }}

      - name: Mount s3 storage
        run: |
          mkdir -p $BUILD_DIR
          rclone -vv mount s3:/mp33/ "$GITHUB_WORKSPACE" --daemon --allow-other --allow-non-empty --use-mmap --vfs-cache-mode full

      - name: Wait until storage is ready
        run: ls "$GITHUB_WORKSPACE"
