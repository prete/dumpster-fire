name: ðŸ»

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  test:  
    name: ðŸ•ðŸ•ðŸ•
    
    runs-on: ubuntu-latest
    container:
      image: quay.io/cellgeni/scrna-seq-course:v5.11
      options: --user root --cap-add SYS_ADMIN 

    env:
      BUILD_DIR: $GITHUB_WORKSPACE/_build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for s3 
        run: rclone config create s3 s3 env_auth false access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} endpoint ${{ secrets.AWS_S3_ENDPOINT }}

      - name: Mount s3 storage
        run: |
          mkdir -p $BUILD_DIR
          rclone mount s3:/mp33/course/ "$BUILD_DIR" --daemon --allow-other --allow-non-empty --use-mmap --vfs-cache-mode full
          until findmnt --mountpoint "$BUILD_DIR" --mtab >/dev/null; do :; done

      - name: Copy course files to build folder
        run : cp -r $GITHUB_WORKSPACE/course_files/* $BUILD_DIR
        
      - name: Render bookdown Rmd files for site generation
        working-directory: ${{ env.BUILD_DIR }}
        run: Rscript -e "bookdown::render_book('index.html', 'bookdown::gitbook')"
