name: Build scRNAseq-course

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  build-course:  
    name: Build scRNAseq-course
    
    runs-on: ubuntu-latest
    container:
      image: quay.io/cellgeni/scrna-seq-course:v5.11
      options: --user root

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: other-v2-signature

    steps:
      - name: Retrieve data from S3
        run: |
          mkdir data
          aws s3 sync s3://mp33/course/data/ ./data --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Retrieve bookdown cache from S3
        run: |
          mkdir _bookdown_files
          aws s3 sync s3://mp33/course/_bookdown_files/ ./_bookdown_files --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Checkout
        uses: actions/checkout@v2
      - name: Render bookdown Rmd files for site generation
        run: echo "Rscript -e bookdown::render_book('index.html', 'bookdown::gitbook')"
      - name: Show
        run: ls -lh
        #run: Rscript -e "bookdown::render_book('index.html', 'bookdown::gitbook')"
      - name: Upload rendered bookdown files to S3
        run: aws s3 sync website  ./website s3://mp33/course/website/ --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Upload bookdown cache to S3
        run: aws s3 sync ./_bookdown_files s3://mp33/course/_bookdown_files/ .  --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
