name: Build scRNAseq-course

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  build-course:  
    name: Build scRNAseq-course
    
    runs-on: ubuntu-latest
#    container:
#      image: quay.io/cellgeni/scrna-seq-course:v5.11
#      options: --user root

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: other-v2-signature
      BUILD_DIR: $GITHUB_WORKSPACE/_build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Create build folder
        run : mkdir -p $BUILD_DIR
      - name: Copy course files to build folder
        run : cp -r $GITHUB_WORKSPACE/course_files/* $BUILD_DIR
      - name: Retrieve course data from S3
        run: |
          mkdir -p $BUILD_DIR/data
          aws s3 sync s3://mp33/course/data/ $BUILD_DIR/data --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Retrieve bookdown cache from S3
        run: |
          mkdir -p /github/home/_bookdown_files
          aws s3 sync s3://mp33/course/_bookdown_files/ $BUILD_DIR/_bookdown_files --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Render bookdown Rmd files for site generation
        working-directory: $BUILD_DIR
        run: |
          ls -l .
          echo "Rscript -e bookdown::render_book('index.html', 'bookdown::gitbook')"
      - name: Upload rendered bookdown files to S3
        run: aws s3 sync $BUILD_DIR/website s3://mp33/course/website/ --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
      - name: Upload bookdown cache to S3
        run: aws s3 sync $BUILD_DIR/_bookdown_files s3://mp33/course/github_bookdown_files/ .  --endpoint-url ${{ secrets.AWS_S3_ENDPOINT }}
