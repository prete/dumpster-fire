name: üêª

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  test:  
    name: üêïüêïüêï
    
    runs-on: ubuntu-latest
    container:
      image: quay.io/cellgeni/scrna-seq-course:v5.11
      options: --user root

    env:
      BUILD_DIR: $GITHUB_WORKSPACE/_build

    steps:
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone for s3 
        run: rclone config create sanger_s3 s3 env_auth false access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }} secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }} endpoint ${{ secrets.AWS_S3_ENDPOINT }}

      - name: Mount s3 storage
        run: rclone mount s3:/mp33/course/ $BUILD_DIR --daemon --vfs-cache-mode full

      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Create build folder
        run : mkdir -p $BUILD_DIR
        
      - name: Copy course files to build folder
        run : cp -r $GITHUB_WORKSPACE/course_files/* $BUILD_DIR
        
      - name: Render bookdown Rmd files for site generation
        working-directory: ${{ env.BUILD_DIR }}
        run: Rscript -e "bookdown::render_book('index.html', 'bookdown::gitbook')"
